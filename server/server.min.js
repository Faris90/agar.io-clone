var Ball,Element,Food,Gamefield,MoveableElement,Obstracle,Player,Shoot,StaticElement,app,express,extend,http,io,path,rooms,serveraddress,serverport,sign,extend1=function(a,b){function c(){this.constructor=a}for(var d in b)hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},hasProp={}.hasOwnProperty,slice=[].slice;extend=exports.extend=function(a,b){var c,d;for(c in b)d=b[c],Array.isArray(d)?a[c]=d.slice(0):"object"==typeof d&&null!==d?(a[c]=a[c]||{},arguments.callee(a[c],d)):a[c]=d;return a},sign=function(a){return a?0>a?-1:1:0},Player=function(){function a(a,b,c,d){this.socket=a,this.name=b,this.color=c,this.room=d,this.socket.on("splitUp",this.splitUp.bind(this)),this.socket.on("shoot",this.shoot.bind(this)),this.socket.on("updateTarget",this.setTarget.bind(this)),this.balls=[this.room.createBall(this)],this.mass=0}return a.prototype.splitUp=function(a){var b,c,d,e,f;for(e=this.balls,c=0,d=e.length;d>c;c++)b=e[c],b.mass>=this.room.options.player.minSpitMass&&(f={x:this.target.x-(b.x-this.x),y:this.target.y-(b.y-this.y)},this.balls.push(b.splitUp(f)));return this.updateMass()},a.prototype.shoot=function(a){var b,c,d,e,f,g;for(f=this.balls,d=0,e=f.length;e>d;d++)c=f[d],c.mass>2*this.room.options.shoot.mass&&(g={x:this.target.x-(c.x-this.x),y:this.target.y-(c.y-this.y)},b=this.room.createShoot(c,g));return this.updateMass()},a.prototype.setTarget=function(a){var b,c,d,e,f,g;for(this.target=a,e=this.balls,f=[],c=0,d=e.length;d>c;c++)b=e[c],g={x:this.target.x-(b.x-this.x),y:this.target.y-(b.y-this.y)},f.push(b.setTarget(g));return f},a.prototype.removeBall=function(a){var b,c,d;d=this.balls;for(c in d)b=d[c],b.id===a.id&&this.balls.splice(c,1);return 0===this.balls.length&&(console.log("Player "+this.name+" got killed"),this.socket.emit("rip")),this.updateMass()},a.prototype.update=function(a){var b,c,d,e,f,g,h;for(this.x=this.y=this.size=0,g=this.balls,c=0,e=g.length;e>c;c++)b=g[c],this.size+=b.size;for(h=this.balls,d=0,f=h.length;f>d;d++)b=h[d],this.x+=b.x*b.size,this.y+=b.y*b.size;return this.x/=this.size,this.y/=this.size,this.size/=this.balls.length},a.prototype.updateMass=function(){var a,b,c,d;for(this.mass=0,d=this.balls,b=0,c=d.length;c>b;b++)a=d[b],this.mass+=a.mass;return this.socket.emit("updatePlayer",this.get())},a.prototype.get=function(){var a;return{name:this.name,mass:this.mass,balls:function(){var b,c,d,e;for(d=this.balls,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.id);return e}.call(this)}},a}(),Element=function(){function a(a,b,c,d,e){this.gamefield=a,this.x=b,this.y=c,this.color=d,this.size=null!=e?e:1,this.id=-1,this.sizechanged=!1}return a.prototype.intercept=function(a){var b;return b=(this.x-a.x)*(this.x-a.x)+(this.y-a.y)*(this.y-a.y),b<=this.size*this.size},a.prototype.canEat=function(a){return!1},a.prototype.get=function(){return{id:this.id,x:this.x,y:this.y,color:this.color,size:this.size}},a.prototype.getPos=function(){var a;return a={id:this.id,x:this.x,y:this.y},this.sizechanged&&(a.size=this.size),a},a}(),StaticElement=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return extend1(b,a),b.prototype.update=function(a){},b}(Element),MoveableElement=function(a){function b(a,c,d,e,f,g){this.gamefield=a,this.x=c,this.y=d,this.color=e,this.size=null!=f?f:1,this.speed=null!=g?g:100,b.__super__.constructor.call(this,this.gamefield,this.x,this.y,this.color,this.size),this.velocity={x:0,y:0},this.boostVel={x:0,y:0},this.boostAcc=0,this.target={x:0,y:0}}return extend1(b,a),b.prototype.setBoost=function(a,b){this.boostVel=a,this.boostAcc=b},b.prototype.setTarget=function(a){this.target=a},b.prototype.update=function(a){var b,c,d,e,f,g,h,i,j,k,l;return(0!==this.boostVel.x||0!==this.boostVel.y)&&(c=-this.boostAcc,k=c*a*sign(this.boostVel.x)+this.boostVel.x,l=c*a*sign(this.boostVel.y)+this.boostVel.y,this.boostVel.x=sign(k)===sign(this.boostVel.x)?k:0,this.boostVel.y=sign(l)===sign(this.boostVel.y)?l:0),b=this.gamefield.options.player.acceleration,0!==this.target.x||0!==this.target.y?(d=Math.atan2(this.target.y,this.target.x),e=Math.cos(d),f=Math.sin(d),k=b*a*e+this.velocity.x,l=b*a*f+this.velocity.y,this.velocity.x=Math.abs(k)>Math.abs(this.speed*e)?this.speed*e:k,this.velocity.y=Math.abs(l)>Math.abs(this.speed*f)?this.speed*f:l):(k=this.velocity.x-b*a*sign(this.velocity.x),l=this.velocity.y-b*a*sign(this.velocity.y),this.velocity.x=sign(k)===sign(this.velocity.x)?k:0,this.velocity.y=sign(l)===sign(this.velocity.y)?l:0),g=(this.boostVel.x+this.velocity.x)*a,h=(this.boostVel.y+this.velocity.y)*a,0<=(i=this.x+g)&&i<=this.gamefield.options.width&&(this.x+=g),0<=(j=this.y+h)&&j<=this.gamefield.options.height&&(this.y+=h),(this.x<0&&g>0||this.x>this.gamefield.options.width&&0>g)&&(this.x+=g),this.y<0&&h>0||this.y>this.gamefield.options.height&&0>h?this.y+=h:void 0},b.prototype.get=function(){var a;return a={x:this.boostVel.x+this.velocity.x,y:this.boostVel.y+this.velocity.y},extend(b.__super__.get.call(this),{velocity:a})},b.prototype.getPos=function(){var a;return a={x:this.boostVel.x+this.velocity.x,y:this.boostVel.y+this.velocity.y},extend(b.__super__.getPos.call(this),{velocity:a})},b}(Element),Gamefield=function(){function a(b,c){var d,e;for(this.name=b,this.options=extend(extend({},a.defaultOptions),c),this.room=io.of("/"+this.name),console.log("Created Room "+this.name),this.player={length:0},this.elements={"static":[],moveable:[],id:1},this.craetedElements=[],this.foodSpawnTimer=0,this.foodCount=0,this.obstracleSpawnTimer=0,this.obstracleCount=0,this.playerUpdateTimer=process.hrtime(),this.timerMoveables=[],this.timerCollision=[],this.timerOther=[],this.sendBufferSize=[],this.updaterStarted=0,d=0,e=this.options.food.max/2;e>=0?e>=d:d>=e;e>=0?d++:d--)this.createFood();this.room.on("connection",function(a){return function(b){return console.log("Client connected to room "+a.name),a.updaterStarted++,1===a.updaterStarted&&a.update(0),b.on("join",function(){var c;return console.log("Client is ready"),b.emit("setElements",slice.call(function(){var a,b,d,e;for(d=this.elements.moveable,e=[],a=0,b=d.length;b>a;a++)c=d[a],e.push(c.get());return e}.call(a)).concat(slice.call(function(){var a,b,d,e;for(d=this.elements["static"],e=[],a=0,b=d.length;b>a;a++)c=d[a],e.push(c.get());return e}.call(a))))}),b.on("leave",function(){return console.log("Client left room "+a.name),b.disconnect()}),b.on("start",function(c){var d,e;return d=a.options.player.color[Math.round(Math.random()*a.options.player.color.length)],console.log("Player "+c+"("+d+") joind the game "+a.name),e=new Player(b,c,d,a),a.player.hasOwnProperty(b.id)||a.player.length++,a.player[b.id]=e,a.room.emit("playerJoined",e.get()),b.emit("start",e.get())}),b.on("disconnect",function(){var c,d,e,f,g,h,i;if(a.updaterStarted--,a.player.hasOwnProperty(b.id)){for(console.log("Player "+a.player[b.id].name+" disconnected"),h=a.player[b.id].balls,f=0,g=h.length;g>f;f++){c=h[f],i=a.elements.moveable;for(e in i)d=i[e],d.id===c.id&&a.elements.moveable.splice(e,1)}return delete a.player[b.id],a.player.length--}}),b.on("getStats",function(){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;for(k=d=m=c=0,o=a.timerMoveables,e=0,g=o.length;g>e;e++)s=o[e],k+=s;for(p=a.timerCollision,f=0,h=p.length;h>f;f++)s=p[f],d+=s;for(q=a.timerOther,l=0,i=q.length;i>l;l++)s=q[l],m+=s;for(r=a.sendBufferSize,n=0,j=r.length;j>n;n++)s=r[n],c+=s;return b.emit("stats",{moveables:k/a.timerMoveables.length,collision:d/a.timerCollision.length,other:m/a.timerOther.length,sendBuffer:c/a.sendBufferSize.length})})}}(this))}return a.defaultOptions={width:5e3,height:5e3,food:{color:"#f1c40f",spawn:5,max:500,mass:1,size:5},player:{color:["#EA6153","#00FFFF","#7FFF00","#6495ED","#9932CC","#FF00FF","#FFE4B5","#000000"],size:15,force:50,acceleration:1e3,speed:300,speedPenalty:.005,eatFactor:1.2,minSpitMass:20,maxMass:1e3},shoot:{mass:10,speed:750,acceleration:400},obstracle:{size:100,max:5,spawn:.2,color:"#00FF00"}},a.prototype.generatePos=function(){return[Math.floor(Math.random()*this.options.width),Math.floor(Math.random()*this.options.height)]},a.prototype.createFood=function(){var a,b,c,d;return this.foodCount++,b=this.generatePos(),c=b[0],d=b[1],a=new Food(this,c,d),a.id=this.elements.id++,this.elements["static"].push(a),this.craetedElements.push(a),a},a.prototype.createObstracle=function(){var a,b,c,d;return this.obstracleCount++,b=this.generatePos(),c=b[0],d=b[1],a=new Obstracle(this,c,d),a.id=this.elements.id++,this.elements["static"].push(a),this.craetedElements.push(a),a},a.prototype.createBall=function(a){var b,c,d,e;return c=this.generatePos(),d=c[0],e=c[1],b=new Ball(this,d,e,a.color,a,this.options.player.size,this.options.player.speed),b.id=this.elements.id++,this.elements.moveable.push(b),this.craetedElements.push(b),b},a.prototype.createShoot=function(a,b){var c,d;return d=Math.atan2(b.y,b.x),c=new Shoot(this,a.x+1.6*a.size*Math.cos(d),a.y+1.6*a.size*Math.sin(d),a.color),c.id=this.elements.id++,a.addMass(-this.options.shoot.mass),c.x<0&&(c.x=0),c.x>this.options.width&&(c.x=this.options.width),c.y<0&&(c.y=0),c.y>this.options.width&&(c.y=this.options.width),c.setTarget(b),this.elements.moveable.push(c),this.craetedElements.push(c),c},a.prototype.destroyElement=function(a){var b,c,d,e,f,g;if(a instanceof StaticElement){a instanceof Food&&this.foodCount--,a instanceof Obstracle&&this.obstracleCount--,d=this.elements["static"],f=[];for(c in d)b=d[c],b.id===a.id?f.push(this.elements["static"].splice(c,1)):f.push(void 0);return f}if(a instanceof MoveableElement){a.player&&a instanceof Ball&&a.player.removeBall(a),e=this.elements.moveable,g=[];for(c in e)b=e[c],b.id===a.id?g.push(this.elements.moveable.splice(c,1)):g.push(void 0);return g}throw"Element is not of type Element"},a.prototype.update=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S;if(this.playerUpdateTimer=process.hrtime(),0!==this.updaterStarted){for(B=this.elements.moveable,l=0,o=B.length;o>l;l++)f=B[l],f.update(a);for(C=this.elements["static"],m=0,p=C.length;p>m;m++)f=C[m],f.update(a);P=process.hrtime(this.playerUpdateTimer),P=1e3*P[0]+1e-6*P[1],c=[],D=this.elements.moveable;for(j in D){for(g=D[j],E=this.elements["static"],n=0,q=E.length;q>n;n++)if(h=E[n],g.intercept(h)){if(g.canEat(h)){g.addMass(h.mass),c.push(h),g.player&&g.player.updateMass();break}if(h.canEat(g)){for(g.addMass(-Math.floor(g.mass/2)),N=[],g.mass>this.options.player.minSpitMass&&N.push(g);N.length>0;)e=N.pop(),b=e.splitUp(e.target),e.mass>this.options.player.minSpitMass&&N.push(e),b.mass>this.options.player.minSpitMass&&N.push(b),g.player&&g.player.balls.push(b);c.push(h),g.player&&g.player.updateMass();break}}for(F=this.elements.moveable,w=0,r=F.length;r>w;w++)h=F[w],g.id!==h.id&&g.intercept(h)&&(g.canEat(h)?(g.addMass(h.mass),c.push(h),g.player&&g.player.updateMass()):h.canEat(g)&&(h.addMass(g.mass),c.push(g),h.player&&h.player.updateMass()))}for(y=0,s=c.length;s>y;y++)e=c[y],this.destroyElement(e);O=process.hrtime(this.playerUpdateTimer),O=1e3*O[0]+1e-6*O[1]-P,G=this.player;for(k in G)z=G[k],"length"!==k&&z.update(a);for(this.foodSpawnTimer+=a,this.foodSpawnTimer>1/this.options.food.spawn&&(this.foodCount<this.options.food.max&&(i=this.createFood()),this.foodSpawnTimer=0),this.obstracleSpawnTimer+=a,this.obstracleSpawnTimer>1/this.options.obstracle.spawn&&(this.obstracleCount<this.options.obstracle.max&&(x=this.createObstracle()),this.obstracleSpawnTimer=0),this.room.emit("updateElements",{deleted:function(){var a,b,d;for(d=[],b=0,a=c.length;a>b;b++)e=c[b],d.push(e.id);return d}(),created:function(){var a,b,c,d;for(c=this.craetedElements,d=[],b=0,a=c.length;a>b;b++)e=c[b],d.push(e.get());return d}.call(this),positions:function(){var a,b,c,d;for(c=this.elements.moveable,d=[],b=0,a=c.length;a>b;b++)e=c[b],d.push(e.getPos());return d}.call(this)}),this.craetedElements=[],H=this.elements.moveable,A=0,t=H.length;t>A;A++)f=H[A],f.sizechanged=!1;for(I=this.elements["static"],R=0,u=I.length;u>R;R++)f=I[R],f.sizechanged=!1;for(d=process.hrtime(this.playerUpdateTimer),M=1e3/60-(1e3*d[0]+1e-6*d[1]),M>=1?setTimeout(function(a){return function(){var b;return b=process.hrtime(a.playerUpdateTimer),a.update(b[0]+1e-9*b[1])}}(this),M):setImmediate(this.update.bind(this,d[0]+1e-9*d[1])),Q=process.hrtime(this.playerUpdateTimer),Q=1e3*Q[0]+1e-6*Q[1]-O-P,this.timerMoveables.unshift(P),this.timerMoveables.length>1e3/60||this.timerMoveables.pop,this.timerCollision.unshift(O),this.timerCollision.length>1e3/60||this.timerCollision.pop,this.timerOther.unshift(Q),this.timerOther.length>1e3/60||this.timerOther.pop,L=0,J=this.room.sockets,S=0,v=J.length;v>S;S++)K=J[S],L+=K.conn.writeBuffer.length;return this.sendBufferSize.unshift(L),this.sendBufferSize.length>1e3/60?void 0:this.sendBufferSize.pop}},a.prototype.get=function(){return{name:this.name,playercount:this.player.length,options:this.options}},a}(),Food=function(a){function b(a,b,c){this.gamefield=a,this.x=b,this.y=c,this.color=this.gamefield.options.food.color,this.mass=this.gamefield.options.food.mass,this.size=this.gamefield.options.food.size}return extend1(b,a),b.prototype.get=function(){return extend(b.__super__.get.call(this),{type:"food"})},b}(StaticElement),Obstracle=function(a){function b(a,b,c){this.gamefield=a,this.x=b,this.y=c,this.color=this.gamefield.options.obstracle.color,this.size=this.gamefield.options.obstracle.size}return extend1(b,a),b.prototype.canEat=function(a){return a.size*this.gamefield.options.player.eatFactor>this.size},b.prototype.get=function(){return extend(b.__super__.get.call(this),{type:"obstracle"})},b}(StaticElement),Ball=function(a){function b(a,c,d,e,f,g,h){this.gamefield=a,this.x=c,this.y=d,this.color=e,this.player=f,this.size=null!=g?g:1,this.speed=null!=h?h:100,b.__super__.constructor.call(this,this.gamefield,this.x,this.y,this.color,this.size,this.speed),this.setMass(20)}return extend1(b,a),b.prototype.setMass=function(a){return this.mass=a,this.size=this.gamefield.options.player.size+150*Math.log((a+150)/150),this.speed=this.gamefield.options.player.speed*Math.exp(-this.gamefield.options.player.speedPenalty*a),this.sizechanged=!0},b.prototype.addMass=function(a){return this.setMass(this.mass+a)},b.prototype.canEat=function(a){return a.mass&&a.size*this.gamefield.options.player.eatFactor<this.size},b.prototype.splitUp=function(a){var b,c,d;return c=Math.atan2(a.y,a.x),d={x:this.gamefield.options.shoot.speed*Math.cos(c),y:this.gamefield.options.shoot.speed*Math.sin(c)},b=this.gamefield.createBall(this.player),b.setMass(Math.floor(this.mass/2)),this.setMass(Math.floor(this.mass/2)),b.x=this.x+1.6*this.size*Math.cos(c),b.x<0&&(b.x=0),b.x>this.gamefield.options.width&&(b.x=this.gamefield.options.width),b.y=this.y+1.6*this.size*Math.sin(c),b.y<0&&(b.y=0),b.y>this.gamefield.options.height&&(b.y=this.gamefield.options.height),b.setTarget(a),b.setBoost(d,this.gamefield.options.shoot.acceleration),b},b.prototype.get=function(){return extend(b.__super__.get.call(this),{name:this.player?this.player.name:void 0,mass:this.mass,type:"ball"})},b}(MoveableElement),Shoot=function(a){function b(a,c,d,e){this.gamefield=a,this.x=c,this.y=d,this.color=e,b.__super__.constructor.call(this,this.gamefield,this.x,this.y,this.color),this.speed=this.gamefield.options.shoot.speed,this.setMass(this.gamefield.options.shoot.mass)}return extend1(b,a),b.prototype.setTarget=function(a){var b,c;return b=Math.atan2(a.y,a.x),c={x:this.speed*Math.cos(b),y:this.speed*Math.sin(b)},this.setBoost(c,this.gamefield.options.shoot.acceleration)},b.prototype.canEat=function(a){return!1},b.prototype.setMass=function(a){var c;return c=this.speed,b.__super__.setMass.call(this,a),this.speed=c},b.prototype.get=function(){return extend(b.__super__.get.call(this),{type:"shoot"})},b}(Ball),path=require("path"),express=require("express"),app=express(),http=require("http").Server(app),io=require("socket.io")(http),app.use(express["static"]("client")),rooms={},rooms["default"]=new Gamefield("default"),rooms.small=new Gamefield("small",{width:2e3,height:2e3,obstracle:{max:2}}),io.on("connection",function(a){return function(a){return console.log("Got new Server connection"),a.on("getRooms",function(){var b;return a.emit("availableRooms",function(){var a;a=[];for(b in rooms)a.push(rooms[b].get());return a}())}),a.on("createRoom",function(b,c){return rooms.hasOwnProperty(b)?a.emit("roomCreated",!1,"Name already exists"):(rooms[b]=new Gamefield(b,c),a.emit("roomCreated",!0))}),a.on("error",function(a){return console.log("Error:",a)})}}(this)),serveraddress=process.env.OPENSHIFT_NODEJS_IP||process.env.IP||"127.0.0.1",serverport=process.env.OPENSHIFT_NODEJS_PORT||process.env.PORT||3e3,http.listen(serverport,serveraddress,function(a){return function(){return console.log("Server listening on "+serveraddress+":"+serverport)}}(this));