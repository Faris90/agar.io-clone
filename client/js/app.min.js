(function(){var a,b,c,d;d=function(a,b){var c,d;for(c in b)d=b[c],a[c]=d;return a},a=function(){function a(a,b){this.options=a,d(this,b),this.updates=0}return a.prototype.updateData=function(a){return d(this,a)},a.prototype.update=function(a){return this.updates++,this.velocity?(this.x+=this.velocity.x*a,this.y+=this.velocity.y*a):void 0},a.prototype.render=function(a){var b;return a.beginPath(),a.strokeStyle=this.options.borderColor,a.fillStyle=this.color||this.options.fillColor,a.lineWidth=this.options.border,a.arc(this.x,this.y,this.size,0,2*Math.PI),a.stroke(),a.fill(),this.name&&""!==this.name?(b=Math.max(this.size/2,this.options.defaultSize),a.lineWidth=this.options.textBorderSize,a.textAlign="center",a.fillStyle=this.options.textColor,a.textBaseline="middle",a.strokeStyle=this.options.textBorder,a.font="bold "+b+"px sans-serif",a.strokeText(this.name,this.x,this.y),a.fillText(this.name,this.x,this.y)):void 0},a}(),c=function(){function a(a,b){this.game=a,this.options=b}return a.prototype.render=function(a){var b,c,d,e,f,g,h,i;for(a.beginPath(),a.lineWidth=1,a.strokeStyle=this.options.lineColor,h=b=0,d=this.game.gamefield.width,e=this.options.size;e>0?d>=b:b>=d;h=b+=e)a.moveTo(h,0),a.lineTo(h,this.game.gamefield.height);for(i=c=0,f=this.game.gamefield.height,g=this.options.size;g>0?f>=c:c>=f;i=c+=g)a.moveTo(0,i),a.lineTo(this.game.gamefield.width,i);return a.stroke(),a.beginPath(),a.lineWidth=this.options.borderSize,a.strokeStyle=this.options.borderColor,a.moveTo(0,0),a.lineTo(0,this.game.gamefield.height),a.lineTo(this.game.gamefield.width,this.game.gamefield.height),a.lineTo(this.game.gamefield.width,0),a.lineTo(0,0),a.stroke()},a}(),b=function(){function b(a){this.options=d(d({},b.defaultOptions),a),this.grid=new c(this,this.options.grid),this.init(),this.lobbySocket.emit("getRooms"),this.lobbySocket.on("availableRooms",function(a){return function(b){var c,e,f;a.rooms=d(b,a.rooms),console.log("Rooms:",a.rooms),a.roomsText.innerHTML="",e=a.rooms;for(c in e)f=e[c],a.roomsText.innerHTML+='<option value="'+c+'" '+(a.lastRoom===c?'selected="selected"':"")+">"+f.name+" ("+f.playercount+")</option>";return a.join(a.lastRoom)}}(this)),this.loop()}return b.prototype.lobbySocket=io(),b.prototype.socket=null,b.prototype.screen={width:window.innerWidth,height:window.innerHeight},b.prototype.view={width:window.innerWidth,height:window.innerHeight},b.prototype.gameStarted=!1,b.prototype.inRoom=!1,b.defaultOptions={viewPortScaleFactor:.01,backgroundColor:"#EEEEEE",grid:{lineColor:"#DADADA",borderColor:"#A0A0A0",borderSize:5,size:50},food:{border:2,borderColor:"#f39c12",fillColor:"#f1c40f",size:5},player:{border:3,borderColor:"#c0392b",fillColor:"#ea6153",textColor:"#FFFFFF",textBorder:"#000000",textBorderSize:3,defaultSize:10},enemy:{border:3,borderColor:"#27ae60",fillColor:"#c0392b",textColor:"#FFFFFF",textBorder:"#000000",textBorderSize:3,defaultSize:10}},b.prototype.player={x:0,y:0,size:0},b.prototype.elements={"static":{},moveable:{}},b.prototype.target={x:0,y:0},b.prototype.fps=0,b.prototype.fpstimer=0,b.prototype.lastTick=0,b.prototype.name="NoName",b.prototype.rooms={},b.prototype.lastRoom=0,b.prototype.setCallbacks=function(b){return this.socket=b,this.socket.on("connect",function(a){return function(){return console.log("Connected")}}(this)),this.socket.on("reconnect",function(a){return function(){return console.log("Reconnected")}}(this)),this.socket.on("playerJoined",function(a){return function(a){return console.log("A player joind:",a)}}(this)),this.socket.on("start",function(a){return function(b){return a.player=b,a.updatePlayer(),a.gameStarted=!0}}(this)),this.socket.on("createFood",function(b){return function(c){return b.elements["static"][c.id]=new a(b.options.food,c)}}(this)),this.socket.on("deleteElement",function(a){return function(b){return a.elements["static"].hasOwnProperty(b)&&delete a.elements["static"][b],a.elements.moveable.hasOwnProperty(b)?delete a.elements.moveable[b]:void 0}}(this)),this.socket.on("updateStatics",function(b){return function(c){var d,e,f,g;for(b.elements["static"]={},g=[],d=0,e=c.length;e>d;d++)f=c[d],g.push(b.elements["static"][f.id]=new a(b.options.food,f));return g}}(this)),this.socket.on("updateMoveables",function(b){return function(c){var d,e,f,g,h,i,j,k;for(b.elements.moveable={},e=0,g=c.length;g>e;e++)i=c[e],b.elements.moveable[i.id]=new a(b.options.enemy,i);if(b.player.balls){for(j=b.player.balls,k=[],f=0,h=j.length;h>f;f++)d=j[f],b.elements.moveable.hasOwnProperty(d)&&k.push(b.elements.moveable[d].options=b.options.player);return k}}}(this)),this.socket.on("updatePlayer",function(a){return function(b){return a.player=b,a.massText.innerHTML="Mass: "+a.player.mass,a.updatePlayer()}}(this)),this.socket.on("rip",function(a){return function(){return a.gameStarted=!1,spawnbox.hidden=!1,a.lobbySocket.emit("getRooms")}}(this)),this.socket.on("disconnect",function(a){return function(){return console.log("Disconnected"),a.socket.close(),a.inRoom=!1}}(this)),this.socket.on("error",function(a){return function(a){return console.log("Error:",a)}}(this)),this.socket.on("stats",function(a){return function(a){return console.log("Stats",a)}}(this))},b.prototype.init=function(){return this.canvas=document.getElementById("cvs"),this.canvas.addEventListener("mousemove",function(a){return function(b){return a.target.x=b.clientX-a.screen.width/2,a.target.y=b.clientY-a.screen.height/2}}(this)),this.canvas.addEventListener("keypress",function(a){return function(b){return 32===b.charCode&&a.socket.emit("splitUp",a.target),119===b.charCode?a.socket.emit("shoot",a.target):void 0}}(this)),this.canvas.width=this.screen.width,this.canvas.height=this.screen.height,window.addEventListener("resize",function(a){return function(){return a.screen.width=window.innerWidth,a.screen.height=window.innerHeight,a.canvas.width=window.innerWidth,a.canvas.height=window.innerHeight}}(this)),this.graph=this.canvas.getContext("2d"),this.massText=document.getElementById("mass"),this.statusText=document.getElementById("status"),this.roomsText=document.getElementById("rooms"),this.nameText=document.getElementById("name"),this.spawnbox=document.getElementById("spawnbox")},b.prototype.join=function(a){return console.log("Joining Room "+this.rooms[a].name),this.gamefield=this.rooms[a].options,this.inRoom&&a!==this.lastRoom?(this.socket.emit("leave"),this.socket.disconnect(),this.inRoom=!1,void setTimeout(function(b){return function(){return b.join(a)}}(this),10)):(console.log("Connecting ..."),this.rooms[a].socket?(this.rooms[a].socket.connected||this.rooms[a].socket.connect(),this.socket=this.rooms[a].socket):(this.rooms[a].socket=io.connect("/"+this.rooms[a].name),this.setCallbacks(this.rooms[a].socket)),this.socket.emit("join"),this.inRoom=!0,this.lastRoom=a,this.updatePlayer())},b.prototype.start=function(){return console.log("Starting Game"),this.name=this.nameText.value,this.socket.emit("start",this.name),spawnbox.hidden=!0,this.canvas.focus()},b.prototype.loop=function(){return window.requestAnimationFrame(function(a){return function(b){var c;return c=b-a.lastTick,a.inRoom&&(a.update(.001*c),a.render()),a.lastTick=b,a.loop()}}(this))},b.prototype.update=function(a){var b,c,d;d=this.elements.moveable;for(b in d)c=d[b],c.update(a);return this.updatePlayer(),this.socket.emit("updateTarget",this.target),this.fpstimer+=a,this.fps++,this.fpstimer>1?(this.statusText.innerHTML="FPS:"+this.fps,this.fps=0,this.fpstimer=0):void 0},b.prototype.updatePlayer=function(){var a,b,c,d,e;if(this.gameStarted){for(this.player.x=this.player.y=this.player.size=0,d=this.player.balls,e=[],b=0,c=d.length;c>b;b++)a=d[b],this.elements.moveable.hasOwnProperty(a)&&(this.player.x+=this.elements.moveable[a].x/this.player.balls.length,this.player.y+=this.elements.moveable[a].y/this.player.balls.length,e.push(this.player.size+=this.elements.moveable[a].size/this.player.balls.length));return e}return this.player.x=this.gamefield.width/2,this.player.y=this.gamefield.height/2,this.player.size=Math.log(Math.min(this.gamefield.width-this.screen.width,this.gamefield.height-this.screen.height))/this.options.viewPortScaleFactor/2},b.prototype.render=function(){var a,b,c,d,e,f,g;this.graph.setTransform(1,0,0,1,0,0),this.graph.fillStyle=this.options.backgroundColor,this.graph.fillRect(0,0,this.screen.width,this.screen.height),g=1/(this.options.viewPortScaleFactor*this.player.size+1),this.graph.setTransform(g,0,0,g,this.screen.width/2-this.player.x*g,this.screen.height/2-this.player.y*g),this.grid.render(this.graph),c=this.elements["static"];for(a in c)f=c[a],f.render(this.graph);d=this.elements.moveable,e=[];for(a in d)b=d[a],e.push(b.render(this.graph));return e},b.prototype.getStats=function(){return this.socket.emit("getStats")},b}(),function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),this.game=new b}).call(this);